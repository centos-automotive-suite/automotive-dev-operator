openapi: 3.0.3
info:
  title: Automotive Build API
  version: 1.0.0
servers:
  - url: /
paths:
  /v1/healthz:
    get:
      summary: Health check
      operationId: healthz
      responses:
        '200':
          description: OK
          content:
            text/plain:
              schema:
                type: string
  /v1/builds:
    get:
      summary: List builds
      operationId: listBuilds
      responses:
        '200':
          description: List of builds
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BuildListItem'
    post:
      summary: Create a build
      operationId: createBuild
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BuildRequest'
      responses:
        '202':
          description: Build accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BuildResponse'
        '400':
          description: Invalid input
  /v1/builds/{name}:
    parameters:
      - in: path
        name: name
        schema:
          type: string
        required: true
    get:
      summary: Get build status
      operationId: getBuild
      responses:
        '200':
          description: Build status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BuildResponse'
        '404':
          description: Not found
  /v1/builds/{name}/logs:
    parameters:
      - in: path
        name: name
        schema:
          type: string
        required: true
      - in: query
        name: follow
        schema:
          type: boolean
        required: false
        description: If true, stream logs
    get:
      summary: Stream build logs
      operationId: streamLogs
      responses:
        '200':
          description: Log stream
          content:
            text/plain:
              schema:
                type: string
        '503':
          description: Logs not available yet
          content:
            text/plain:
              schema:
                type: string
  /v1/builds/{name}/uploads:
    parameters:
      - in: path
        name: name
        schema:
          type: string
        required: true
    post:
      summary: Upload local files referenced by manifest
      operationId: uploadFiles
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: Upload complete
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
        '503':
          description: Upload pod not ready
          content:
            text/plain:
              schema:
                type: string
  /v1/builds/{name}/progress:
    parameters:
      - in: path
        name: name
        schema:
          type: string
        required: true
    get:
      summary: Get build progress
      operationId: getBuildProgress
      description: Returns the current build phase and, for active builds, the latest progress step from build script markers.
      responses:
        '200':
          description: Build progress
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BuildProgress'
        '404':
          description: Not found
  /v1/builds/{name}/template:
    parameters:
      - in: path
        name: name
        schema:
          type: string
        required: true
    get:
      summary: Get a build's inputs as a template
      operationId: getBuildTemplate
      responses:
        '200':
          description: Build template
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BuildTemplateResponse'
        '404':
          description: Not found
components:
  schemas:
    BuildRequest:
      type: object
      required: [name, manifest]
      properties:
        name:
          type: string
        manifest:
          type: string
          description: Manifest YAML content
        manifestFileName:
          type: string
          default: manifest.aib.yml
        distro:
          type: string
        target:
          type: string
        architecture:
          type: string
        exportFormat:
          type: string
        mode:
          type: string
        automotiveImageBuilder:
          type: string
          default: quay.io/centos-sig-automotive/automotive-image-builder:1.1.11
        storageClass:
          type: string
        runtimeClassName:
          type: string
        customDefs:
          type: array
          items:
            type: string
        aibExtraArgs:
          type: array
          items:
            type: string
        useInternalRegistry:
          type: boolean
          description: Push disk images to OpenShift internal registry (mutually exclusive with exportOci; can be combined with containerPush for hybrid builds)
        internalRegistryImageName:
          type: string
          description: Override image name for internal registry (default is build name)
        internalRegistryTag:
          type: string
          description: Tag for internal registry image (default is build name)
    BuildResponse:
      type: object
      properties:
        name:
          type: string
        phase:
          type: string
        message:
          type: string
        requestedBy:
          type: string
          nullable: true
    BuildListItem:
      type: object
      properties:
        name:
          type: string
        requestedBy:
          type: string
          nullable: true
    BuildProgress:
      type: object
      properties:
        phase:
          type: string
          description: ImageBuild phase (Pending, Building, Completed, Failed, etc.)
        step:
          $ref: '#/components/schemas/BuildStep'
      required:
        - phase
    BuildStep:
      type: object
      description: A progress checkpoint emitted by the build script
      properties:
        stage:
          type: string
          description: Human-readable stage name
        done:
          type: integer
          description: Number of steps completed
        total:
          type: integer
          description: Total number of steps
      required:
        - stage
        - done
        - total
    BuildTemplateResponse:
      allOf:
        - $ref: '#/components/schemas/BuildRequest'
        - type: object
          properties:
            sourceFiles:
              type: array
              items:
                type: string
        phase:
          type: string
        message:
          type: string
        createdAt:
          type: string
          format: date-time

